<html>
    <head>
        <title>KonvaTest</title>
        <style>
            h1 {text-align: center;}
            p {text-align: center;}
            div {text-align: center;}
        </style>
    </head>
    <body>
        <div id="main" style="align-self:center"></div>
        
        <!--KonvaJS v7.0.3 -->
        <script src="konva.js"></script>
        
        <script>
            var simUPS = 20;
            var simFPS = 60;

            function ship(color) {
                this.x = 0;
                this.y = 0;
                this.rot = 0;
                this.speed = 10 * simFPS / simUPS;
                this.rotSpeed = 30;
                this.avoidDist = 500;
                this.HP = 0;
                this.attackRange = 10;
                this.attackDamage = 1;
                this.attackCooldown = 1;
                this.team = color;
                this.poly = new Konva.Line({
                    points: [-5, -10, 
                             25, 0,
                             -5, 10,
                             5, 0],
                    fill: color,
                    strokeEnabled: false,
                    //stroke: 'black',
                    //strokeWidth: 1,
                    closed: true,
                });
                this.poly.cache();
            }
            
            var width = window.innerWidth - 18;
            var height = window.innerHeight - 18;
            var stage = new Konva.Stage({
                container: 'main',
                width: width,
                height: height,
            });
            var unitLayer = new Konva.Layer();
            stage.on("mousedown", function() {
                        simUpdate();
                    })

            //debug text
            var text = new Konva.Text({
                x: 10,
                y: 10,
                fontFamily: 'Calibri',
                fontSize: 20,
                text: '',
                fill: 'black',
            });
            unitLayer.add(text);
            function writeMessage(message) {
                text.text(message);
            }


            var circles = [];
            for(var x = 0; x < 1; x++) {
                circles[x] = [];
                for(var y = 0; y < 1; y++) {
                    circles[x][y] = new ship("red");
                    circles[x][y].x = 35 * x + 335;
                    circles[x][y].y = 35 * y + 335
                    unitLayer.add(circles[x][y].poly);
                }
            }
            var border = new Konva.Rect({
                x: 0,
                y: 0,
                width: stage.width(),
                height: stage.height(),
                fillEnabled: false,
                stroke: 'black',
                strokeWidth: 4,
            });
            unitLayer.add(border);
            // add the layer to the stage
            stage.add(unitLayer);
            stage.draw();

            countFPS = (function () {
                var lastLoop = (new Date()).getMilliseconds();
                var count = 1;
                var fps = 0;
            
                return function () {
                    var currentLoop = (new Date()).getMilliseconds();
                    if (lastLoop > currentLoop) {
                        fps = count;
                        count = 1;
                    } else {
                        count += 1;
                    }
                    lastLoop = currentLoop;
                    return fps;
                };
            }());
            
            countUPS = (function () {
                var lastLoop = (new Date()).getMilliseconds();
                var count = 1;
                var fps = 0;
            
                return function () {
                    var currentLoop = (new Date()).getMilliseconds();
                    if (lastLoop > currentLoop) {
                        fps = count;
                        count = 1;
                    } else {
                        count += 1;
                    }
                    lastLoop = currentLoop;
                    return fps;
                };
            }());

            var UPS = 0;
            var debugRot = 0;
            function simUpdate() {           
                lastUpdate = new Date().getMilliseconds();

                for(var x = 0; x < circles.length; x++) {
                    for(var y = 0; y < circles[x].length; y++) {
                        var unit = circles[x][y];
                        if(unit.rot > 360) {
                            unit.rot -= 360;
                        }
                        if(unit.rot < -360) {
                            unit.rot -= -360;
                        }
                    }
                }
                for(var x = 0; x < circles.length; x++) {
                    for(var y = 0; y < circles[x].length; y++) {
                        var unit = circles[x][y];
                        
                        var angleRADS = (Math.PI / 180) * unit.rot;
                        var forx = unit.speed * Math.cos(angleRADS);
                        var fory = unit.speed * Math.sin(angleRADS);

                        unit.x += forx;
                        unit.y += fory;
                        unit.poly.to({
                                duration: 1 / simUPS,
                                x: unit.x,
                                y: unit.y,
                        });
                    }
                }

                var pos = stage.getPointerPosition();
                if(pos != null && pos != NaN) {
                    for(var x = 0; x < circles.length; x++) {
                        for(var y = 0; y < circles[x].length; y++) {
                            var unit = circles[x][y];
                            var diff = {x: 0, y: 0};
                            diff.x = pos.x - unit.x;
                            diff.y = pos.y - unit.y;
                            var mag = Math.sqrt((diff.x * diff.x) + (diff.y * diff.y));
                            console.log("magnitude is " + mag);
                            diff.x = diff.x / mag;
                            diff.y = diff.y / mag;
                            var rot = Math.atan2(diff.y, diff.x) * (360 / (Math.PI * 2));
                            console.log("direction towards le mousâ‚¬ is " + rot);

                            var addRot = unit.rotSpeed;
                            var rotDiff = unit.rot - rot;
                            debugRot = rotDiff;
                            console.log("unit rot is " + unit.rot);
                            console.log("rot difference between unit and target is " + rotDiff);
                            if (mag < unit.avoidDist) {
	                        	if (rotDiff > 0) {
                                    console.log("rot is positive, therefore we go left");
	                        		//Left
	                        		addRot *= -1;
	                        	}
	                        	else {
                                    //Right
                                    console.log("rot is negtive, therefore we go right");
	                        		addRot = addRot;
	                        	}
	                        }
	                        else if (rotDiff < 0) {
	                        	//Left
                                addRot *= -1;
	                        }
	                        else {
	                        	//Right
	                        	addRot = addRot;
	                        }
                            unit.rot += addRot;
                            unit.poly.to({
                                duration: 1 / simUPS,
                                rotation: unit.rot,
                            });
                        }
                    }
                }
                UPS = countUPS();
                //self.setTimeout("simUpdate()", 1000 / simUPS);
            }
            function update() {
                writeMessage("FPS: " + countFPS() + "\n" + "UPS: " + UPS + "\n" + "DebugRotation: " + debugRot);
                unitLayer.draw();
                self.setTimeout("update()", 1000 / simFPS);
            }
            simUpdate();
            update();
        </script>    
    </body>
</html>